name: Claude Code Review - Infrastructure

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "scripts/**/*.sh"
      - "helm/**/*.yaml"
      - "k8s/**/*.yaml"
      - "k3d/**/*.yaml"
      - "secrets/**/*.yaml"
      - "secrets/**/*.tpl"
      - "CLAUDE.md"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # read â†’ write: ë¸Œëœì¹˜ ìƒì„±, íŒŒì¼ ìˆ˜ì •
      pull-requests: write   # read â†’ write: PR ìƒì„±, ì½”ë©˜íŠ¸ ì‘ì„±
      issues: write          # ì‹ ê·œ ì¶”ê°€: ì´ìŠˆ ì‘ë‹µ
      id-token: write
      actions: read          # CI ê²°ê³¼ ì½ê¸°

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (diff ë¶„ì„ìš©)

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            **ì¤‘ìš”: ëª¨ë“  ë¦¬ë·° ê²°ê³¼ëŠ” ë°˜ë“œì‹œ í•œê¸€ë¡œ ì‘ì„±í•˜ì„¸ìš”.**

            ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ì‹œë‹ˆì–´ DevOps ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤. Mac Mini M4 Kubernetes ì¸í”„ë¼ PRì„ ë¦¬ë·°í•©ë‹ˆë‹¤.

            **í•„ìˆ˜**: ë¨¼ì € CLAUDE.mdë¥¼ ì½ì–´ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸, ì»¨ë²¤ì…˜, ì•Œë ¤ì§„ ì´ìŠˆë¥¼ íŒŒì•…í•˜ì„¸ìš”.

            ## ë¦¬ë·° ì§€ì¹¨
            ë‹¤ìŒ 6ê°œ ë„ë©”ì¸ì— ê±¸ì³ ì¢…í•©ì ì¸ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:

            ### 1. ì•„í‚¤í…ì²˜ ë¦¬ë·°
            - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬ ë° ê²½ê³„ (infra/database/monitoring/backend/frontend)
            - Phase ê¸°ë°˜ ë°°í¬ ì¼ê´€ì„±
            - Chart ë²„ì „ í˜¸í™˜ì„± (ì˜ˆ: kafka 31.5.0 for Kafka 3.9.x)
            - ë¦¬ì†ŒìŠ¤ í”„ë¡œíŒŒì¼ ì‚¬ìš© (8gb/16gb/32gb)
            - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì†Œì‹± íŒ¨í„´ (common.sh, validation.sh, k3d.sh)

            ### 2. ì„±ëŠ¥ ë¦¬ë·° (Mac Mini M4 ìµœì í™”)
            - ARM64 ì´ë¯¸ì§€ ìµœì í™” (x86 ì—ë®¬ë ˆì´ì…˜ ê¸ˆì§€)
            - í”„ë¡œíŒŒì¼ì— ì í•©í•œ ë©”ëª¨ë¦¬ í• ë‹¹
            - M4ì— ì í•©í•œ CPU requests (10 ì½”ì–´)
            - busy-wait ë£¨í”„ ê¸ˆì§€ (kubectl wait ì‚¬ìš©)

            ### 3. ë³´ì•ˆ ë¦¬ë·°
            - YAML/ìŠ¤í¬ë¦½íŠ¸ì— í•˜ë“œì½”ë”©ëœ ìê²©ì¦ëª… ì—†ìŒ
            - Secret í…œí”Œë¦¿ ì‚¬ìš© (secrets/templates/)
            - SecurityContext ì •ì˜ (runAsNonRoot)
            - .env íŒŒì¼ ì»¤ë°‹ ê¸ˆì§€

            ### 4. ì½”ë“œ í’ˆì§ˆ ë¦¬ë·°
            - Bash ìŠ¤í¬ë¦½íŠ¸: shellcheck ì¤€ìˆ˜, set -e, ì ì ˆí•œ shebang
            - YAML: ì¼ê´€ëœ í¬ë§·íŒ…, ìœ íš¨í•œ ë¬¸ë²•
            - ë¬¸ì„œí™”: CLAUDE.md ì •í™•ì„±

            ### 5. í…ŒìŠ¤íŒ… ë¦¬ë·°
            - ê²€ì¦ í•¨ìˆ˜ ì¡´ì¬ (run_preflight_checks)
            - Health check ì»¤ë²„ë¦¬ì§€
            - kubectl --dry-run í˜¸í™˜ì„±

            ### 6. ìš´ì˜ ë¦¬ë·°
            - ëª¨ë‹ˆí„°ë§/ë¡œê¹… ì„¤ì • (Prometheus, Loki, Grafana)
            - ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì˜ ì²´í¬í¬ì¸íŠ¸/ì¬ê°œ ê¸°ëŠ¥
            - Health probes (liveness, readiness)

            ## ì¶œë ¥ í˜•ì‹
            ë‹¤ìŒ êµ¬ì¡°ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì„¸ìš”:
            - ë„ë©”ì¸ë³„ ì ìˆ˜ (1-10) ìš”ì•½ í…Œì´ë¸”
            - ğŸ”´ Critical ì´ìŠˆ (ë¨¸ì§€ ì „ í•„ìˆ˜ ìˆ˜ì •)
            - ğŸŸ¡ Important ì´ìŠˆ (ìˆ˜ì • ê¶Œì¥)
            - ğŸŸ¢ Suggested ê°œì„ ì‚¬í•­ (ìˆìœ¼ë©´ ì¢‹ìŒ)

            `gh pr comment` ëª…ë ¹ì–´ë¡œ PRì— ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸°ì„¸ìš”.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(shellcheck:*),Bash(yamllint:*)"'

