name: Claude Code Review - Infrastructure

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "scripts/**/*.sh"
      - "helm/**/*.yaml"
      - "k8s/**/*.yaml"
      - "k3d/**/*.yaml"
      - "secrets/**/*.yaml"
      - "secrets/**/*.tpl"
      - "CLAUDE.md"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # read → write: 브랜치 생성, 파일 수정
      pull-requests: write   # read → write: PR 생성, 코멘트 작성
      issues: write          # 신규 추가: 이슈 응답
      id-token: write
      actions: read          # CI 결과 읽기

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 (diff 분석용)

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a 20-year senior DevOps engineer reviewing this Mac Mini M4 Kubernetes infrastructure PR.

            **CRITICAL**: First read CLAUDE.md for project context, conventions, and known issues.

            ## Review Instructions
            Perform a comprehensive review across these 6 domains:

            ### 1. Architecture Review
            - Namespace separation and boundaries (infra/database/monitoring/backend/frontend)
            - Phase-based deployment consistency
            - Chart version compatibility (e.g., kafka 31.5.0 for Kafka 3.9.x)
            - Resource profile usage (8gb/16gb/32gb)
            - Library sourcing patterns (common.sh, validation.sh, k3d.sh)

            ### 2. Performance Review (Mac Mini M4 Focus)
            - ARM64 image optimization (no x86 emulation)
            - Memory allocations appropriate for profile
            - CPU requests reasonable for M4 (10 cores)
            - No busy-wait loops (use kubectl wait)

            ### 3. Security Review
            - No hardcoded credentials in YAML/scripts
            - Secret template usage (secrets/templates/)
            - SecurityContext definitions (runAsNonRoot)
            - .env files not committed

            ### 4. Code Quality Review
            - Bash scripts: shellcheck compliance, set -e, proper shebang
            - YAML: consistent formatting, valid syntax
            - Documentation: CLAUDE.md accuracy

            ### 5. Testing Review
            - Validation functions present (run_preflight_checks)
            - Health check coverage
            - kubectl --dry-run compatibility

            ### 6. Operations Review
            - Monitoring/logging configuration (Prometheus, Loki, Grafana)
            - Checkpoint/resume capability in deploy scripts
            - Health probes (liveness, readiness)

            ## Output Format
            Provide a structured review with:
            - Summary table with scores (1-10) per domain
            - Critical issues (must fix before merge)
            - Important issues (should fix)
            - Suggested improvements (nice to have)

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(shellcheck:*),Bash(yamllint:*)"'

