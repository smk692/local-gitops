# 공유기 포트 포워딩 설정 가이드

Mac Mini k3s 클러스터를 외부에서 접근 가능하도록 공유기 포트 포워딩을 설정하는 가이드입니다.

---

## 📋 필요 정보

| 항목 | 값 | 설명 |
|------|-----|------|
| **Mac Mini 내부 IP** | `192.168.45.135` | 확인됨 |
| **k3s HTTP NodePort** | `31599` | 확인됨 |
| **k3s HTTPS NodePort** | `31818` | 확인됨 |
| **외부 HTTP 포트** | `80` | 표준 HTTP |
| **외부 HTTPS 포트** | `443` | 표준 HTTPS |

---

## 🎯 설정 목표

```
인터넷
  ↓
공유기 (공인 IP)
  ↓ 포트 포워딩
  80 → 192.168.45.135:31599 (HTTP)
  443 → 192.168.45.135:31818 (HTTPS)
  ↓
Mac Mini k3s Cluster
```

---

## 1️⃣ 공유기 관리자 페이지 접속

### 1.1 공유기 IP 확인

대부분의 공유기는 다음 IP 중 하나를 사용합니다:

- ipTIME: `192.168.0.1` 또는 `192.168.0.254`
- KT: `192.168.219.1` 또는 `172.30.1.254`
- SK Broadband: `192.168.1.1`
- 일반 공유기: `192.168.1.1` 또는 `192.168.0.1`

### 1.2 로그인

브라우저에서 공유기 IP로 접속:
```
http://192.168.0.1  (또는 해당 IP)
```

**초기 비밀번호**:
- ipTIME: admin / admin
- KT: ktuser / homehub
- SK Broadband: admin / admin

---

## 2️⃣ Mac Mini IP 예약 (중요!)

포트 포워딩 전에 반드시 Mac Mini IP를 고정해야 합니다.

### ipTIME 공유기

1. **고급 설정** → **내부 네트워크 설정** → **DHCP 서버 설정**
2. **수동 IP 할당** 목록에서 **추가** 클릭
3. 정보 입력:
   - **MAC 주소**: Mac Mini의 MAC 주소 선택
   - **IP 주소**: `192.168.45.135`
   - **설명**: `Mac Mini k3s`
4. **적용** 클릭

### KT 공유기

1. **네트워크 관리** → **내부 네트워크 관리** → **수동IP 할당**
2. **추가** 클릭
3. 정보 입력:
   - **MAC 주소**: Mac Mini MAC 주소 선택
   - **IP 주소**: `192.168.45.135`
4. **저장** 클릭

### SK Broadband 공유기

1. **고급 설정** → **LAN 설정** → **DHCP 설정**
2. **정적 IP 할당** 추가
3. Mac Mini MAC 주소와 `192.168.45.135` 매핑
4. **저장** 클릭

---

## 3️⃣ 포트 포워딩 설정

### ipTIME 공유기 (가장 일반적)

#### 3.1 포트 포워딩 메뉴 접속
1. **관리도구** → **고급 설정** → **NAT/라우터 관리**
2. **포트포워드 설정** 선택

#### 3.2 규칙 1: HTTP (포트 80)
| 필드 | 값 |
|------|-----|
| **규칙 이름** | `k3s-http` |
| **내부 IP 주소** | `192.168.45.135` |
| **프로토콜** | `TCP` |
| **외부 포트** | `80` |
| **내부 포트** | `31599` |

**추가** 버튼 클릭

#### 3.3 규칙 2: HTTPS (포트 443)
| 필드 | 값 |
|------|-----|
| **규칙 이름** | `k3s-https` |
| **내부 IP 주소** | `192.168.45.135` |
| **프로토콜** | `TCP` |
| **외부 포트** | `443` |
| **내부 포트** | `31818` |

**추가** 버튼 클릭

#### 3.4 적용
**적용** 또는 **저장** 버튼 클릭

---

### KT 공유기

#### 3.1 포트 포워딩 메뉴
1. **고급 설정** → **NAT 설정** → **포트 포워딩**

#### 3.2 규칙 추가
| 서비스명 | 외부포트 | 내부IP | 내부포트 | 프로토콜 |
|---------|---------|--------|---------|---------|
| `k3s-http` | `80` | `192.168.45.135` | `31599` | TCP |
| `k3s-https` | `443` | `192.168.45.135` | `31818` | TCP |

**추가** → **저장**

---

### SK Broadband 공유기

#### 3.1 포트 포워딩 메뉴
1. **고급 설정** → **NAT 설정** → **가상 서버**

#### 3.2 규칙 추가
- **HTTP**: 외부 `80` → 내부 `192.168.45.135:31599` (TCP)
- **HTTPS**: 외부 `443` → 내부 `192.168.45.135:31818` (TCP)

**저장** 클릭

---

## 4️⃣ Double NAT 확인 및 해결

### 4.1 Double NAT란?

ISP 모뎀 + 공유기 두 단계 NAT로 인해 포트 포워딩이 안 되는 상황

### 4.2 Double NAT 확인

**공유기 WAN IP 확인**:
1. 공유기 관리 페이지
2. **네트워크 정보** 또는 **WAN 설정** 확인
3. WAN IP가 `192.168.x.x` 또는 `10.x.x.x`이면 **Double NAT**

### 4.3 KT/SK Broadband Double NAT 해결

**Bridge 모드 설정** (ISP 모뎀을 단순 브리지로 변경):

#### KT 기가지니/올레 WiFi
1. ISP 모뎀 관리 페이지 접속: `172.30.1.254`
2. **고급 설정** → **동작 모드** → **브리지 모드**로 변경
3. 재부팅 후 공유기 WAN IP가 공인 IP로 변경 확인

#### SK Broadband
1. ISP 모뎀 관리 페이지 접속
2. **고급** → **브리지 모드** 활성화
3. 공유기 재설정 필요할 수 있음

**⚠️ 주의**: Bridge 모드 설정 후 ISP 모뎀의 WiFi 기능은 비활성화됩니다.

---

## 5️⃣ 방화벽 설정 (필요 시)

일부 공유기는 추가 방화벽 설정이 필요합니다.

### ipTIME
1. **보안 기능** → **공격 차단 설정**
2. **포트 80, 443**에 대한 차단 해제

### KT
일반적으로 추가 설정 불필요

### SK Broadband
1. **보안** → **방화벽**
2. **포트 80, 443** 허용 규칙 추가

---

## 6️⃣ 설정 확인

### 6.1 로컬 테스트

Mac Mini에서:
```bash
# 공유기 내부 IP로 테스트
curl -H "Host: son.duckdns.org" http://192.168.45.135:31599
```

### 6.2 외부 IP 확인

```bash
curl ifconfig.me
```

현재 공인 IP를 확인합니다.

### 6.3 DuckDNS에 IP 등록

```bash
# DuckDNS 스크립트 실행
~/duckdns/duck.sh

# 로그 확인
cat ~/duckdns/duck.log
```

`OK` 또는 `KO`가 표시됩니다:
- `OK`: 성공
- `KO`: 토큰 또는 도메인 오류

### 6.4 외부 접근 테스트 (포트 포워딩 완료 후)

**다른 네트워크(모바일 데이터 등)에서**:
```bash
curl http://son.duckdns.org
```

또는 브라우저에서:
```
http://son.duckdns.org
```

OAuth2 로그인 페이지가 나타나면 성공!

---

## 🔧 문제 해결

### 문제 1: 외부에서 접근 안 됨

**확인 사항**:
1. Mac Mini IP가 `192.168.45.135`로 고정되었는지
   ```bash
   ifconfig | grep "inet "
   ```
2. 포트 포워딩 규칙이 올바른지
3. Double NAT 여부 확인
4. ISP가 포트 80을 차단하는지 확인

**대안**: 외부 포트를 8080으로 변경
```
외부 8080 → 내부 192.168.45.135:31599
```
접속 시: `http://son.duckdns.org:8080`

### 문제 2: 일부 ISP 포트 차단

**차단되는 포트**: 80, 8080, 21, 25

**해결**:
- 외부 포트를 `8888`, `8443` 등으로 변경
- 또는 **Cloudflare Tunnel 사용** (포트 포워딩 불필요)

### 문제 3: DuckDNS IP 업데이트 안 됨

```bash
# 수동으로 IP 확인
curl ifconfig.me

# DuckDNS에 수동 업데이트
curl "https://www.duckdns.org/update?domains=son&token=YOUR_TOKEN&ip="

# 응답: OK 또는 KO
```

---

## ✅ 최종 체크리스트

포트 포워딩 설정 완료 전 확인:

- [ ] Mac Mini IP가 `192.168.45.135`로 고정됨
- [ ] 포트 포워딩 규칙 두 개 추가됨:
  - [ ] 외부 80 → 내부 192.168.45.135:31599
  - [ ] 외부 443 → 내부 192.168.45.135:31818
- [ ] Double NAT 확인 및 해결 (필요 시)
- [ ] DuckDNS IP 업데이트 완료
- [ ] 로컬에서 `192.168.45.135:31599` 접근 가능
- [ ] `/etc/hosts` 설정으로 `son.duckdns.org` 로컬 테스트 성공

---

## 📚 다음 단계

1. ✅ 공유기 포트 포워딩 완료
2. ⏭️ **다음**: 외부 접근 테스트 (`test-external-access.sh`)

---

## 🔗 참고 자료

- [ipTIME 포트포워드 설정 매뉴얼](http://www.iptime.co.kr)
- [KT 홈허브 설정 가이드](https://www.kt.com)
- [DuckDNS FAQ](https://www.duckdns.org/faqs.jsp)
