# PostgreSQL Helm Chart Values for Mac Mini
# Using Bitnami PostgreSQL Chart with ARM64 support

# PostgreSQL architecture
architecture: standalone

# Authentication
auth:
  # Admin user credentials
  # IMPORTANT: Set via environment variables or secrets/postgres-password.txt
  # Example: --set auth.postgresPassword=$(cat secrets/postgres-password.txt)
  postgresPassword: ""  # Will be set during deployment
  username: "appuser"
  password: ""          # Will be set during deployment
  database: "appdb"

  # Create additional user (optional)
  # existingSecret: "postgresql-secret"

# Primary server configuration
primary:
  # Resource limits optimized for Mac Mini
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Persistence
  persistence:
    enabled: true
    storageClass: "local-path"
    size: 10Gi

  # PostgreSQL configuration (optimized for 16GB Mac Mini)
  extendedConfiguration: |
    # Connection settings
    max_connections = 150
    superuser_reserved_connections = 3

    # Memory settings (optimized for 2GB limit)
    shared_buffers = 512MB
    effective_cache_size = 1536MB
    maintenance_work_mem = 128MB
    work_mem = 3MB

    # Checkpoint settings
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    min_wal_size = 1GB
    max_wal_size = 4GB

    # Query planner
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200

    # Parallel query
    max_worker_processes = 4
    max_parallel_workers_per_gather = 2
    max_parallel_workers = 4
    max_parallel_maintenance_workers = 2

    # Logging (for production monitoring)
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_line_prefix = '%m [%p] %q%u@%d '
    log_timezone = 'UTC'

    # Performance monitoring
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all

    # Security settings
    password_encryption = scram-sha-256

  # PgBouncer connection pooling (optimized for small team)
  pgBouncer:
    enabled: true
    resources:
      limits:
        cpu: 250m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

    # Transaction mode is more efficient for most applications
    poolMode: transaction

    # Connection limits (optimized for small team)
    maxClientConnections: 200
    defaultPoolSize: 10
    minPoolSize: 5
    reservePoolSize: 5

    # Timeouts
    serverIdleTimeout: 600

    # Additional PgBouncer settings
    custom: |
      pool_mode = transaction
      max_client_conn = 200
      default_pool_size = 10
      min_pool_size = 5
      reserve_pool_size = 5
      server_idle_timeout = 600
      server_lifetime = 3600
      server_connect_timeout = 15
      query_timeout = 0
      query_wait_timeout = 120
      client_idle_timeout = 0
      idle_transaction_timeout = 0

  # Security context
  podSecurityContext:
    enabled: true
    fsGroup: 1001
  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsNonRoot: true

# Service configuration
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# Metrics configuration (for Prometheus)
metrics:
  enabled: true
  resources:
    limits:
      cpu: 250m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  serviceMonitor:
    enabled: false  # Enable if Prometheus Operator is installed

# Backup configuration
backup:
  enabled: false
  # To enable automated backups:
  # enabled: true
  # cronjob:
  #   schedule: "0 2 * * *"  # Daily at 2 AM
  #   storage:
  #     storageClass: "local-path"
  #     size: 5Gi
